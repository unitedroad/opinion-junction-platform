from django.shortcuts import render_to_response, render
from django.http import HttpResponse, HttpResponseRedirect
from django.template import RequestContext, Template
from allauth.socialaccount.adapter import get_adapter
from .forms import perform_login, complete_signup, user_username
from django.shortcuts import render_to_response, render
from allauth.account.adapter import get_adapter as get_account_adapter
from django.forms import ValidationError
from allauth.account import app_settings as account_settings
from allauth.exceptions import ImmediateHttpResponse

def _process_signup(request, sociallogin):
    auto_signup = get_adapter().is_auto_signup_allowed(request,
                                                       sociallogin)
    if not auto_signup:
        if request.is_ajax():
            response = {}
            response['ok'] = 'false'
            response['code'] = 'auto_signup_not_possible'
            response['message'] = 'Auto Signup not possible with this account. Try signing up with another social account or contact Admin.'
            c = RequestContext(request,{'response':json.dumps(response)})
            t = Template("{% autoescape off %}{{response}}{% endautoescape %}") # A dummy template
            return HttpResponse(t.render(c), mimetype="application/json")

        request.session['socialaccount_sociallogin'] = sociallogin.serialize()
        url = reverse('socialaccount_signup')
        ret = HttpResponseRedirect(url) #we need to make this view support ajax if we don't have auto signup enabled
    else:
        # Ok, auto signup it is, at least the e-mail address is ok.                                                                                                                                                       
        # We still need to check the username though...                                                                                                                                                                   
        if account_settings.USER_MODEL_USERNAME_FIELD:
            username = user_username(sociallogin.account.user)
            try:
                get_account_adapter().clean_username(username)
            except ValidationError:
                # This username is no good ...                                                                                                                                                                            
                user_username(sociallogin.account.user, '')
        # FIXME: This part contains a lot of duplication of logic                                                                                                                                                         
        # ("closed" rendering, create user, send email, in active                                                                                                                                                         
        # etc..)                                                                                                                                                                                                          
        try:
            if not get_adapter().is_open_for_signup(request,
                                                    sociallogin):
                if request.is_ajax():
                    reponse = {}
                    response['ok'] = 'false'
                    response['code'] = 'signup_closed'
                    response['message'] = 'Closed for signup'
                    c = RequestContext(request,{'response':json.dumps(response)})
                    t = Template("{% autoescape off %}{{response}}{% endautoescape %}") # A dummy template
                    return HttpResponse(t.render(c), mimetype="application/json")

                return render(request,
                              "account/signup_closed.html") #support if request.is_ajax()
        except ImmediateHttpResponse as e:
            if request.is_ajax():
                response['html'] = e.response.content.decode('utf8')
                return HttpResponse(json.dumps(response),
                                    status=response.status_code,
                                    content_type='application/json')
            return e.response #support if request.is_ajax()
        get_adapter().save_user(request, sociallogin, form=None)
        ret = complete_social_signup(request, sociallogin)
    return ret

def _login_social_account(request, sociallogin):
    return perform_login(request, sociallogin.account.user,
                         email_verification=app_settings.EMAIL_VERIFICATION,
                         redirect_url=sociallogin.get_redirect_url(request),
                         signal_kwargs={"sociallogin": sociallogin})

def _complete_social_login(request, sociallogin):
    if request.user.is_authenticated():
        logout(request)
    if sociallogin.is_existing:
        # Login existing user                                                                                                                                                                                             
        ret = _login_social_account(request, sociallogin)
    else:
        # New social user                                                                                                                                                                                                 
        ret = _process_signup(request, sociallogin)
    return ret


def complete_social_signup(request, sociallogin):
    return complete_signup(request,
                           sociallogin.account.user,
                           app_settings.EMAIL_VERIFICATION,
                           sociallogin.get_redirect_url(request),
                           signal_kwargs={'sociallogin': sociallogin})
